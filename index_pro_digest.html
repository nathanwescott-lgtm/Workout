<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Holiday Coach ‚Äî Today</title>
<meta name="theme-color" content="#002FA7" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect width='100%' height='100%' fill='%23002FA7'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='128' fill='%23ffffff'>HC</text></svg>'>
<style>
  :root{
    --primary:#002FA7; /* Yves Klein Blue */
    --accent:#7BB661;  /* Brat Green */
    --bg:#0A0F14;
    --card:#0D1522;
    --ink:#E9EEF6;
    --muted:#9EB1C9;
    --border:#1A2942;
    --chip:#0F1B2E;
    --warn:#F6C350;
    --bad:#F06A6A;
    --ok:#7BB661;
    --shadow: 0 10px 30px rgba(3,10,20,.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 600px at 20% -10%, rgba(0,47,167,.25), transparent 60%) ,radial-gradient(900px 600px at 100% 0%, rgba(123,182,97,.18), transparent 45%), var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(10,15,20,.95),rgba(10,15,20,.75),transparent);border-bottom:1px solid var(--border);backdrop-filter:saturate(120%) blur(6px)}
  .wrap{max-width:980px;margin:0 auto;padding:14px 16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .card{background:linear-gradient(180deg,rgba(13,21,34,.9),rgba(13,21,34,.8));border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin:12px 0;box-shadow:var(--shadow)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:linear-gradient(180deg, var(--chip), rgba(12,19,31,.6));color:var(--muted);font-weight:600}
  .btn{background:linear-gradient(180deg, var(--accent), #5EA04D);color:#081208;font-weight:800;border:0;border-radius:14px;padding:14px 16px;cursor:pointer;box-shadow:0 6px 18px rgba(123,182,97,.35)}
  .btn.alt{background:linear-gradient(180deg, var(--primary), #001F76);color:#fff;box-shadow:0 6px 18px rgba(0,47,167,.35)}
  .btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
  input,select{background:#0B1424;color:var(--ink);border:1px solid var(--border);border-radius:12px;padding:12px}
  h1{margin:0;font-size:1.15rem}
  .muted{color:var(--muted)}
  .headline{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .countdown{background:var(--accent); color:#061309; border:1px solid #5ca24f; padding:6px 10px; border-radius:10px; font-weight:800}
  .actions{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
  @media(max-width:860px){.actions{grid-template-columns:repeat(2,1fr)}}
  .list{display:grid;gap:10px}
  .item{display:flex;justify-content:space-between;gap:10px;border:1px solid var(--border);border-radius:12px;background:rgba(12,20,36,.8);padding:12px}
  .timer{font-variant-numeric:tabular-nums}
  .ring{width:90px;height:90px;position:relative}
  .ring svg{transform:rotate(-90deg)}
  .ring .num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:50}
  .modal>.box{background:linear-gradient(180deg,rgba(13,21,34,.97),rgba(13,21,34,.9));border:1px solid var(--border);border-radius:14px;padding:16px;width:min(92vw,680px);box-shadow:var(--shadow)}
  .chart{width:100%;height:120px;background:#0b1220;border:1px solid var(--border);border-radius:12px}
  .small{font-size:.92rem}
  .warn{background:#2a1e06;color:#ffe8b8;border:1px solid #3a2a0a;padding:8px 10px;border-radius:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="headline">
      <div>
        <h1>Holiday Coach ‚Äî Today</h1>
        <div class="muted">Chest & Arms priority ¬∑ Spin/Boxing conditioning</div>
      </div>
      <div class="row">
        <div class="ring" title="Daily completion">
          <svg viewBox="0 0 36 36" width="90" height="90">
            <path d="M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32" fill="none" stroke="rgba(255,255,255,.08)" stroke-width="3"/>
            <path id="ringArc" d="M18 2 a 16 16 0 1 1 0 32 a 16 16 0 1 1 0 -32" fill="none" stroke="url(#grad)" stroke-width="3" stroke-dasharray="0,100"/>
            <defs><linearGradient id="grad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#7BB661"/><stop offset="100%" stop-color="#002FA7"/></linearGradient></defs>
          </svg>
          <div class="num" id="ringNum">0%</div>
        </div>
        <div id="countdown" class="countdown">‚Äî</div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="pill" id="phasePill">Bulk</span>
      <span class="pill" id="kcalPill">2950 kcal</span>
      <span class="pill" id="summaryPill">0 kcal ¬∑ 0 g P</span>
      <span class="pill" id="streakPill">Streak 0</span>
      <span class="pill" id="beerPill">Beer 0/4</span>
      <button class="btn alt" id="resetDay">Reset</button>
      <button class="btn ghost" id="exportData">Export</button>
      <button class="btn ghost" id="importData">Import</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Quick Actions -->
  <section class="card">
    <div class="actions">
      <button class="btn" id="startWorkout">Start Workout</button>
      <button class="btn" id="logMeal">+ Meal / Barcode</button>
      <button class="btn" id="weighIn">Weigh-in</button>
      <button class="btn" id="addBeer">+ Beer</button>
      <button class="btn ghost" id="exportIcs">Calendar (.ics)</button>
      <button class="btn ghost" id="openTrends">Trends</button>
      <button class="btn ghost" id="openDigest">Weekly Digest</button>
      <button class="btn ghost" id="openSettings">Settings</button>
      <button class="btn ghost" id="tips">Tips</button>
    </div>
  </section>

  <!-- Workout guided card -->
  <section class="card" id="workoutCard" style="display:none"></section>

  <!-- Today‚Äôs Log -->
  <section class="card">
    <h3>Today‚Äôs log</h3>
    <div id="logList" class="list"></div>
  </section>

  <!-- Trends -->
  <section class="card">
    <h3>Progress</h3>
    <div class="row small muted">Weight (30d) ¬∑ Training Volume (8 sessions)</div>
    <svg id="weightChart" class="chart"></svg>
    <div style="height:8px"></div>
    <svg id="volumeChart" class="chart"></svg>
  </section>

  
  <!-- Sunday Prep (Shopping + Batch Cook) -->
  <section class="card">
    <h3>Sunday Prep</h3>
    <div class="row small muted">Chicken‚Äìrice‚Äìveg base ¬∑ No fish ¬∑ No beef ¬∑ Low cleanup</div>
    <div class="row" style="margin-top:8px">
      <span class="pill">Mode: <select id="prepMode">
        <option value="bulk" selected>Bulk (Mon‚ÄìAug 31)</option>
        <option value="cut">Cut (Sept‚ÄìOct)</option>
      </select></span>
      <button class="btn" id="markPrepDone">Mark All Done</button>
    </div>
    <div style="height:8px"></div>
    <div class="row"><strong>Shopping List (Weekly)</strong></div>
    <div class="list small" id="shopList"></div>
    <div style="height:8px"></div>
    <div class="row"><strong>Batch Cook Steps</strong></div>
    <div class="list small" id="prepSteps"></div>
  </section>

  <!-- Reliability banner -->
  <section class="card">
    <div class="warn small">Pro tip: Add to Home Screen (Share ‚Üí Add to Home Screen) for full-screen and offline use.</div>
  </section>
</main>

<!-- Modal -->
<div id="modal" class="modal"><div class="box" id="modalBox"></div></div>

<script>
/* ===== Utilities & storage with versioning ===== */
const APP_VERSION = 3;
function $(id){return document.getElementById(id)}
const S = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
const G = (k,d)=>JSON.parse(localStorage.getItem(k) || JSON.stringify(d));
const todayKey = ()=> new Date().toISOString().slice(0,10);
function nowTime(){ return new Date().toLocaleTimeString(); }

(function migrate(){
  const v = G('APP_VERSION',0);
  if(v < APP_VERSION){
    S('APP_VERSION', APP_VERSION);
  }
})();

/* ===== Countdown & ring ===== */
function updateCountdown(){
  const t = new Date("2025-10-25T00:00:00Z").getTime();
  const d = t - Date.now();
  $('countdown').textContent = d<0 ? "Holiday! üèù" : Math.max(0,Math.floor(d/86400000)) + " days";
}
updateCountdown(); setInterval(updateCountdown, 3600000);
function setRing(pct){
  const p = Math.max(0,Math.min(100,Math.round(pct)));
  $('ringArc').setAttribute('stroke-dasharray', p+",100");
  $('ringNum').textContent = p+"%";
}

/* ===== Phase & kcal ===== */
function currentPhase(){ return new Date() < new Date("2025-09-15T00:00:00Z") ? "Bulk" : "Cut"; }
function targetKcal(){ return currentPhase()==="Bulk" ? 2950 : 2550; }
$('phasePill').textContent = currentPhase(); $('kcalPill').textContent = targetKcal()+" kcal";

/* ===== Audio / Vibration / Voice ===== */
let audioCtx;
function beep(ms=220, freq=880){
  try{
    audioCtx = audioCtx||new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination); o.type='sine'; o.frequency.value=freq; g.gain.setValueAtTime(0.05,audioCtx.currentTime);
    o.start(); setTimeout(()=>{o.stop()}, ms);
  }catch(e){}
}
function vibrate(pattern=[150,80,150]){ if(navigator.vibrate) navigator.vibrate(pattern); }
function speak(txt){
  if (!('speechSynthesis' in window)) return;
  try{
    const u = new SpeechSynthesisUtterance(txt); u.rate=1.0; u.pitch=1.0; u.volume=1.0; speechSynthesis.cancel(); speechSynthesis.speak(u);
  }catch(e){}
}

/* ===== Day state ===== */
let day = G('day:'+todayKey(), { kcal:0, protein:0, beers:0, entries:[], sets:[], goals:{workout:false, protein:false, steps:false} });
let beers = day.beers;
let streak = G('streak',0);
let lastTrainDate = G('lastTrainDate', null);
let lastLifts = G('lastLifts', {});
let weekIndex = G('weekIndex',1);

/* ===== UI helpers ===== */
function modal(html){ $('modalBox').innerHTML = html; $('modal').style.display='flex'; }
document.getElementById('modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') $('modal').style.display='none'; });

/* ===== Pills / log / rings ===== */
function updatePills(){
  $('summaryPill').textContent = `${Math.round(day.kcal)} kcal ¬∑ ${Math.round(day.protein)} g P`;
  $('beerPill').textContent = `Beer ${beers}/${G('beerAllow',4)}`;
  $('streakPill').textContent = `Streak ${streak}`;
  const completed = (day.goals.workout?33:0) + (day.goals.protein?33:0) + (day.goals.steps?34:0);
  setRing(completed);
}
function renderLog(){
  $('logList').innerHTML = day.entries.slice().reverse().map(e=>`
    <div class="item"><div>${e.text}</div><div class="muted">${e.time}</div></div>
  `).join('') || `<div class="muted">Nothing logged yet.</div>`;
}
function saveDay(){ day.beers = beers; S('day:'+todayKey(), day); updatePills(); renderLog(); }
updatePills(); renderLog();

/* ===== Settings ===== */
$('openSettings').onclick = ()=>{
  const allow = G('beerAllow',4);
  modal(`
    <h3>Settings</h3>
    <div class="row"><label class="pill">Beer allowance/wk: <input id="setBeer" type="number" min="0" value="${allow}" style="width:100px"></label></div>
    <div class="row"><button class="btn" id="saveSettings">Save</button><button class="btn ghost" id="closeSettings">Close</button></div>
  `);
  $('saveSettings').onclick=()=>{ S('beerAllow', parseInt($('setBeer').value||"4",10)); $('modal').style.display='none'; updatePills(); };
  $('closeSettings').onclick=()=>{ $('modal').style.display='none'; };
};

/* ===== Reset / Export / Import ===== */
$('resetDay').onclick = ()=>{ day={kcal:0,protein:0,beers:0,entries:[],sets:[], goals:{workout:false, protein:false, steps:false}}; beers=0; saveDay(); $('workoutCard').style.display='none'; };
$('exportData').onclick = ()=>{
  const all = {}; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); all[k]=localStorage.getItem(k); }
  const blob = new Blob([JSON.stringify(all,null,2)],{type:'application/json'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download="holiday-coach-data.json"; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500);
};
$('importData').onclick = ()=>{
  modal(`<h3>Import Data</h3><input type="file" id="imp" accept="application/json"/><div class="row"><button class="btn" id="doImp">Import</button></div>`);
  $('doImp').onclick=()=>{
    const f=$('imp').files[0]; if(!f) return;
    const rdr=new FileReader(); rdr.onload=()=>{ try{
      const obj=JSON.parse(rdr.result); Object.entries(obj).forEach(([k,v])=>localStorage.setItem(k,v)); location.reload();
    }catch(e){alert("Import failed");} }; rdr.readAsText(f);
  };
};

/* ===== Weigh-in ===== */
$('weighIn').onclick = ()=>{
  const w = prompt("Weight (kg)?", "");
  const v = parseFloat(w);
  if(!isNaN(v)){
    const hist = G('weightHistory',[]);
    hist.push({d:todayKey(), w:v});
    S('weightHistory', hist);
    day.entries.push({text:`Weigh-in: ${v} kg`, time:nowTime()});
    saveDay(); drawCharts();
  }
};

/* ===== Tips ===== */
$('tips').onclick = ()=>{
  modal(`
    <h3>Quick Tips</h3>
    <ul class="small">
      <li><b>Protein floor:</b> 165‚Äì170 g/day. Tick the protein ring by logging meals.</li>
      <li><b>Spin days:</b> 40‚Äì60 g carbs pre/post so lifting doesn‚Äôt suffer.</li>
      <li><b>Progressive overload:</b> +2.5 kg or +1 rep each week somewhere.</li>
      <li><b>Beer:</b> Keep to 4/wk; avoid the night before heavy pressing/legs.</li>
      <li><b>Sleep:</b> &ge;7.5 h on training nights; if &lt;7 h, skip beer today.</li>
    </ul>
    <div class="row"><button class="btn" onclick="document.getElementById('modal').style.display='none'">Close</button></div>
  `);
};

/* ===== Meal logging (manual or barcode) ===== */
$('logMeal').onclick = ()=>{
  modal(`
    <h3>Add Meal</h3>
    <div class="row"><button class="btn" id="manual">Manual</button><button class="btn alt" id="barcode">Scan / Barcode</button><button class="btn ghost" id="closeMeal">Close</button></div>
    <div id="mealBox" class="small muted" style="margin-top:8px">Choose an option.</div>
  `);
  $('closeMeal').onclick=()=>{$('modal').style.display='none';};

  $('manual').onclick = ()=>{
    $('mealBox').innerHTML = `
      <div class="row">Enter either:
        <ul>
          <li>kcal,protein  <i>(e.g., 643,21)</i></li>
          <li>per100_kcal,per100_protein,grams  <i>(e.g., 278,9.2,231)</i></li>
        </ul>
      </div>
      <input id="mealInput" placeholder="e.g., 643,21" style="width:100%">
      <div class="row"><button class="btn" id="addManual">Add</button></div>
    `;
    $('addManual').onclick = ()=>{
      const parts = $('mealInput').value.split(',').map(s=>s.trim());
      let kcal=0,p=0,label="";
      if(parts.length===2){ kcal=parseFloat(parts[0]); p=parseFloat(parts[1]); label="Meal"; }
      else if(parts.length===3){ const pk=parseFloat(parts[0]), pp=parseFloat(parts[1]), g=parseFloat(parts[2]); kcal=pk*(g/100); p=pp*(g/100); label=`Meal ${g}g`; }
      if(isNaN(kcal)||isNaN(p)) return alert("Numbers not recognised.");
      day.kcal+=kcal; day.protein+=p; day.entries.push({text:`${label}: +${Math.round(kcal)} kcal, +${Math.round(p)} g P`, time:nowTime()});
      if(day.protein>=165) day.goals.protein=true;
      saveDay(); $('modal').style.display='none';
    };
  };

  $('barcode').onclick = ()=>{
    $('mealBox').innerHTML = `
      <div class="row"><input id="code" placeholder="Barcode (e.g., 5000159406239)" style="flex:1"><button class="btn" id="lookup">Lookup</button></div>
      <div class="row small muted">Or use camera: <button class="btn ghost" id="scanCam">Open Scanner</button></div>
      <div id="foodResult" class="small" style="margin-top:8px"></div>
    `;
    $('lookup').onclick = async ()=>{
      const code = $('code').value.trim(); if(!code) return;
      try{
        const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
        const j = await res.json();
        if(!j.product) return $('foodResult').innerHTML = `<span class="pill" style="background:#2a0f12;border-color:#4a1f22;color:#ffb3b3">Not found</span>`;
        const p = j.product.nutriments||{};
        const kcal = p['energy-kcal_100g'] || p['energy-kcal'] || 0;
        const protein = p['proteins_100g'] || 0;
        $('foodResult').innerHTML = `
          <div class="item" style="flex-direction:column;align-items:flex-start">
            <b>${j.product.product_name||"Unknown product"}</b>
            <div class="muted">per 100g: ${Math.round(kcal)} kcal, ${protein} g protein</div>
            <div class="row"><label>Grams: <input id="grams" type="number" style="width:120px" value="100"></label>
            <button class="btn" id="addFood">Add</button></div>
          </div>`;
        $('addFood').onclick=()=>{
          const g = parseFloat(($('grams')||{value:100}).value)||100;
          const addK = kcal*(g/100), addP = protein*(g/100);
          day.kcal+=addK; day.protein+=addP; day.entries.push({text:`${j.product.product_name||"Food"} ${g}g: +${Math.round(addK)} kcal, +${Math.round(addP)} g P`, time:nowTime()});
          if(day.protein>=165) day.goals.protein=true;
          saveDay(); $('modal').style.display='none';
        };
      }catch(e){ $('foodResult').textContent = "Network error"; }
    };
    $('scanCam').onclick = ()=>{
      const s=document.createElement('script'); s.src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js";
      s.onload=()=>{
        $('mealBox').innerHTML += `<div id="scanner" style="position:relative;height:260px;margin-top:8px;background:#000"></div>`;
        Quagga.init({ inputStream:{ type:"LiveStream", constraints:{ facingMode:"environment" }, target:document.querySelector('#scanner') }, decoder:{ readers:["ean_reader","upc_reader","upc_e_reader"] }}, (err)=> {
          if(err){ $('foodResult').innerHTML = `<span class="pill" style="background:#2a1e06;border-color:#3a2a0a;color:#ffe8b8">Camera error</span>`; return; }
          Quagga.start();
          Quagga.onDetected((data)=>{ const code=data.codeResult.code; $('code').value=code; Quagga.stop(); alert("Detected: "+code); });
        });
      };
      document.body.appendChild(s);
    };
  };
};

/* ===== Beer ===== */
$('addBeer').onclick = ()=>{ beers++; day.entries.push({text:"Beer +1", time:nowTime()}); saveDay(); };

/* ===== Workouts ===== */
const programs = {
  "Chest & Push (heavy)": { restMain:90, restAcc:60, list:["Incline Barbell Bench","Flat Dumbbell Press","Overhead Press","Dumbbell Lateral Raise","Bench Dips"] },
  "Back & Arms": { restMain:90, restAcc:60, list:["Barbell Row","One-Arm Dumbbell Row","Barbell Curl","Hammer Curl","Upright Row (or Band Face Pull)"] },
  "Arms & Chest Pump": { restMain:75, restAcc:60, list:["Incline Dumbbell Press","Incline Dumbbell Fly","Close-Grip Bench","Barbell Curl","Lateral Raise","Overhead DB Triceps"] },
  "Spin/Boxing (conditioning)": { restMain:0, restAcc:0, list:["45‚Äì60 min conditioning (RPE 7‚Äì9). Fuel: 40‚Äì60 g carbs pre/post."] }
};
function startTimer(span, secs, nextName){
  clearInterval(span._t); let s=secs;
  const tick=()=>{ if(s<=0){ clearInterval(span._t); span.textContent="Go!"; vibrate(); beep(250,1200); speak(nextName?`Rest over. Next: ${nextName}`:`Rest over`); return; }
    span.textContent=`Rest ${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`; s--; };
  tick(); span._t=setInterval(tick,1000);
}
function renderWorkout(name){
  const p = programs[name];
  $('workoutCard').style.display='block';
  $('workoutCard').innerHTML = `
    <div class="headline"><h3>${name}</h3><div class="row"><span class="pill ${ (weekIndex%5===0) ? 'warn':''}">Week ${weekIndex}${(weekIndex%5===0)?' ¬∑ Deload':''}</span><button class="btn ghost" id="closeWo">Close</button></div></div>
    ${p.list.map((ex,ix)=>`
      <div class="item" style="flex-direction:column;align-items:stretch">
        <div class="row" style="justify-content:space-between">
          <strong>${ix+1}. ${ex}</strong>
          <span class="muted">Last: ${(lastLifts[ex]?.w ?? "‚Äî")} kg √ó ${(lastLifts[ex]?.r ?? "‚Äî")}</span>
        </div>
        ${p.restMain?`
        <div class="row">
          <label>Weight (kg): <input id="w_${ix}" type="number" inputmode="decimal" style="width:110px" value="${lastLifts[ex]?.w ?? ''}"></label>
          <label>Reps: <input id="r_${ix}" type="number" inputmode="numeric" style="width:90px" value="${lastLifts[ex]?.r ?? ''}"></label>
          <button class="btn alt" id="rest_${ix}">Rest</button>
          <span class="muted timer" id="t_${ix}">Ready</span>
        </div>`:`<div class="muted">Conditioning session. Log in Health if using Watch.</div>`}
      </div>
    `).join('')}
    <div class="row" style="justify-content:flex-end">
      <button class="btn ghost" id="swap">Swap Workout</button>
      <button class="btn" id="finishWo">Finish Session</button>
    </div>
  `;
  $('closeWo').onclick = ()=>{ $('workoutCard').style.display='none'; };
  $('swap').onclick = ()=> startWorkout(true);
  p.list.forEach((ex,ix)=>{
    const btn = $('rest_'+ix), lab = $('t_'+ix);
    if(btn) btn.onclick = ()=>{
      const isMain = ix<=2; startTimer(lab, isMain?p.restMain:p.restAcc, p.list[ix+1]||"Next set");
    };
  });
  $('finishWo').onclick = ()=>{
    p.list.forEach((ex,ix)=>{
      const w=parseFloat(($('w_'+ix)||{}).value); const r=parseInt(($('r_'+ix)||{}).value,10);
      if(!isNaN(w)&&!isNaN(r)) lastLifts[ex]={w,r};
    });
    S('lastLifts', lastLifts);
    const key = todayKey();
    if(lastTrainDate && lastTrainDate!==key){
      const diff = (new Date(key)-new Date(lastTrainDate))/86400000;
      streak = diff<=2 ? (streak+1) : 1;
    } else if(!lastTrainDate){ streak = 1; }
    lastTrainDate = key; S('lastTrainDate', lastTrainDate); S('streak', streak);
    day.goals.workout = true;
    day.entries.push({text:`Workout: ${name} ‚úÖ`, time:nowTime()});
    saveDay();
    speak("Session saved. Nice work!");
    alert("Session saved ‚Äî keep pushing +2.5 kg or +1 rep somewhere next time.");
    $('workoutCard').style.display='none';
  };
}
function startWorkout(allowCancel=false){
  const options = Object.keys(programs);
  const choice = prompt("Choose workout:
1) Chest & Push (heavy)
2) Back & Arms
3) Arms & Chest Pump
4) Spin/Boxing", "1");
  if(!choice){ if(allowCancel) return; else return; }
  const idx = parseInt(choice,10)-1;
  const name = options[idx] || options[0];
  renderWorkout(name);
}
$('startWorkout').onclick = ()=> startWorkout(false);

/* ===== Calendar export (8 weeks) ===== */
$('exportIcs').onclick = ()=>{
  const NL="
"; const esc=s=>String(s).replace(/[,
;]/g,' ');
  const now = new Date().toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z/,'Z');
  let ics = "BEGIN:VCALENDAR"+NL+"VERSION:2.0"+NL+"PRODID:-//HC//EN"+NL;
  const start = new Date(); start.setHours(18,0,0,0);
  const spinDays = [1,3,6]; // Mon/Wed/Sat
  const types = ["Chest & Push (heavy)","Back & Arms","Arms & Chest Pump","Back & Arms"];
  for(let i=0;i<56;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    const dow=d.getDay();
    const type = spinDays.includes(dow) ? "Spin/Boxing (conditioning)" : types[(dow+6)%7 % 4];
    const st=new Date(d); st.setHours(18,0,0,0);
    const et=new Date(st); et.setHours(et.getHours()+1);
    const ds=st.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z/,'Z');
    const de=et.toISOString().replace(/[-:]/g,'').replace(/\.\d{3}Z/,'Z');
    ics+="BEGIN:VEVENT"+NL+"UID:HC-"+ds+"@hc"+NL+"DTSTAMP:"+now+NL+"DTSTART:"+ds+NL+"DTEND:"+de+NL+"SUMMARY:"+esc(type)+NL+"END:VEVENT"+NL;
  }
  ics+="END:VCALENDAR";
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([ics],{type:'text/calendar'})); a.download="HolidayCoach.ics"; a.click();
};

/* ===== Charts ===== */
function drawLine(svgId, data, color="#7BB661"){
  const svg=$(svgId); if(!svg) return;
  const W=svg.clientWidth||600, H=svg.clientHeight||120, pad=12;
  const minX=0, maxX=data.length?data.length-1:1;
  const vals=data.map(d=>d.y);
  const minY=Math.min(...vals,0), maxY=Math.max(...vals,1);
  const sx = x=> pad + (x-minX)/(maxX-minX||1)*(W-pad*2);
  const sy = y=> H-pad - (y-minY)/(maxY-minY||1)*(H-pad*2);
  let d="";
  data.forEach((p,i)=>{ d += (i?"L":"M")+sx(i)+","+sy(p.y)+" "; });
  svg.innerHTML = `<path d="${d}" fill="none" stroke="${color}" stroke-width="2"/><g>${data.map((p,i)=>`<circle cx="${sx(i)}" cy="${sy(p.y)}" r="2" fill="${color}"/>`).join('')}</g>`;
}
function drawCharts(){
  const hist = G('weightHistory',[]).slice(-30);
  drawLine('weightChart', hist.map(x=>({y:x.w})));
  const vols = G('volumeHist',[]).slice(-8);
  drawLine('volumeChart', vols.map(x=>({y:x.v||0})), "#4DA0FF");
}
drawCharts();

/* ===== Trends modal ===== */
$('openTrends').onclick = ()=>{
  const hist = G('weightHistory',[]);
  const lastW = hist.length?hist[hist.length-1].w:"‚Äî";
  modal(`
    <h3>Trends</h3>
    <ul class="small">
      <li><b>Current weight:</b> ${lastW} kg</li>
      <li><b>Protein ring:</b> ${day.goals.protein? "‚úÖ hit":"‚è≥ not yet"} (>=165 g)</li>
      <li><b>Workout ring:</b> ${day.goals.workout? "‚úÖ hit":"‚è≥ not yet"}</li>
      <li><b>Steps ring:</b> ${day.goals.steps? "‚úÖ hit":"‚è≥ not yet"} (manual)</li>
    </ul>
    <div class="row"><button class="btn" id="closeTrends">Close</button></div>
  `);
  $('closeTrends').onclick=()=>{$('modal').style.display='none'};
};


/* ===== Sunday Prep (Shopping + Batch) ===== */
const SHOP = {
  bulk: [
    {t:"Chicken breast", q:"2.5‚Äì3.0 kg"},
    {t:"Rice (basmati or jasmine)", q:"2.0 kg dry"},
    {t:"Greek yogurt 0‚Äì5% fat", q:"2 x 1 kg tubs"},
    {t:"Vegan protein powder", q:"~1 bag (60g/day)"},
    {t:"Oats", q:"1 kg"},
    {t:"Peanut butter (smooth)", q:"1 jar (500 g)"},
    {t:"Peanuts", q:"500 g"},
    {t:"Berries (frozen ok)", q:"1.5‚Äì2.0 kg"},
    {t:"Cherry juice", q:"2 L"},
    {t:"Wraps (white)", q:"1‚Äì2 packs"},
    {t:"Mixed veg (broccoli, peppers, onions)", q:"3‚Äì4 kg total"},
    {t:"Beans (kidney/black)", q:"4 cans"},
    {t:"Tomato passata + puree", q:"4 cartons + 2 tubes"},
    {t:"Stock cubes (chicken/veg)", q:"1 box"},
    {t:"Spices (paprika, garlic, thyme, curry, scotch bonnet or chili)", q:"top-up"},
    {t:"Olive oil / spray oil", q:"1 bottle + 1 can spray"},
    {t:"Honey", q:"1 squeezy bottle"},
    {t:"Creatine monohydrate", q:"1 tub"}
  ],
  cut: [
    {t:"Chicken breast", q:"2.0‚Äì2.3 kg"},
    {t:"Rice (basmati or jasmine)", q:"1.2‚Äì1.5 kg dry"},
    {t:"Greek yogurt 0%‚Äì2% fat", q:"2 x 1 kg tubs"},
    {t:"Vegan protein powder", q:"~1 bag (60g/day)"},
    {t:"Oats", q:"750 g"},
    {t:"Peanut butter (smooth)", q:"1 small jar (300‚Äì400 g)"},
    {t:"Peanuts", q:"300‚Äì400 g"},
    {t:"Berries (frozen ok)", q:"1.2‚Äì1.5 kg"},
    {t:"Cherry juice", q:"1‚Äì1.5 L"},
    {t:"Wraps (white)", q:"1 pack"},
    {t:"Mixed veg (broccoli, peppers, onions, carrots)", q:"3 kg total"},
    {t:"Beans (kidney/black)", q:"3 cans"},
    {t:"Tomato passata + puree", q:"3 cartons + 1 tube"},
    {t:"Stock cubes (chicken/veg)", q:"1 box"},
    {t:"Spices", q:"top-up"},
    {t:"Olive oil / spray oil", q:"spray + small bottle"},
    {t:"Honey", q:"1 bottle (optional)"},
    {t:"Creatine monohydrate", q:"1 tub"}
  ]
};

const STEPS = [
  {t:"Chicken: oven 200¬∞C ‚Äî 18‚Äì22 min (2‚Äì3 trays). Season with paprika, garlic, thyme, salt. Spray oil, line with foil for easy cleanup."},
  {t:"Rice: rice cooker or pot ‚Äî 1:1.6 rice:water. Big batch ~1.5‚Äì2.0 kg dry ‚Üí store in containers. Fluff and cool quickly."},
  {t:"Roast veg: 200¬∞C ‚Äî 20‚Äì25 min (broccoli, peppers, onions). Spray oil + salt/pepper."},
  {t:"Jollof base (optional dinner batch): saut√© onions + puree + spices 5‚Äì7 min; add passata + stock; simmer 10‚Äì12 min; add par-cooked rice; steam low 12‚Äì15 min."},
  {t:"Beans: rinse cans; portion into dinner containers with chicken + rice."},
  {t:"Snack pots: yogurt + berries prepped; nuts & PB measured (cut phase: halve nuts/PB)."},
  {t:"Label portions (Bulk: larger carbs/fats; Cut: slightly smaller carbs/fats). Store 3‚Äì4 days fresh, freeze the rest."},
  {t:"Cleanup: foil-lined trays; silicone mats; stackable containers ready."}
];

function renderPrep(){
  const mode = $('prepMode').value;
  const list = SHOP[mode];
  $('shopList').innerHTML = list.map((x,i)=>`
    <label class="item" style="align-items:center">
      <div><input type="checkbox" id="chk_${mode}_${i}"> <strong>${x.t}</strong><div class="muted">${x.q}</div></div>
    </label>
  `).join('');
  $('prepSteps').innerHTML = STEPS.map((s,i)=>`
    <label class="item" style="align-items:center">
      <div><input type="checkbox" id="stp_${i}"> ${s.t}</div>
    </label>
  `).join('');
}
$('prepMode').addEventListener('change', renderPrep);
renderPrep();

$('markPrepDone').onclick = ()=>{
  day.entries.push({text:`Sunday Prep ‚úÖ (${ $('prepMode').value })`, time:nowTime()});
  saveDay();
  day.goals.steps = day.goals.steps || true;
  alert("Nice ‚Äî prep done. You‚Äôre set for the week.");
};


/* ===== Weekly Digest (auto on Sundays 20:00 + manual button) ===== */
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function formatDate(d){ return new Date(d).toISOString().slice(0,10); }
function getPastDays(n){
  const out=[]; const today = startOfDay(new Date());
  for(let i=0;i<n;i++){ const dt = new Date(today); dt.setDate(today.getDate()-i); out.push(formatDate(dt)); }
  return out.reverse();
}
function getWeeklyStats(){
  const last7 = getPastDays(7);
  let proteinHits=0, workouts=0, beersTotal=0;
  let entries=0;
  last7.forEach(k=>{
    const d = G('day:'+k, null);
    if(!d) return;
    entries++;
    if(d.goals && d.goals.protein) proteinHits++;
    if(d.entries){ workouts += d.entries.filter(e=> (e.text||'').startsWith('Workout:')).length; }
    beersTotal += d.beers||0;
  });
  // weight change: compare last value within the first day to last value now
  const wh = G('weightHistory',[]);
  let wStart=null, wEnd=null;
  if(wh.length){
    const weekStart = last7[0], weekEnd = last7[last7.length-1];
    for(let i=0;i<wh.length;i++){ if(wh[i].d <= weekStart){ wStart = wh[i].w; } }
    for(let i=wh.length-1;i>=0;i--){ if(wh[i].d <= weekEnd){ wEnd = wh[i].w; break; } }
  }
  const delta = (wStart!=null && wEnd!=null) ? (wEnd - wStart) : null;
  return { proteinHits, workouts, beersTotal, daysLogged: entries, weightDelta: delta };
}
function digestText(){
  const s = getWeeklyStats();
  const dir = (s.weightDelta==null) ? "‚Äì" : (s.weightDelta>0?`+${s.weightDelta.toFixed(1)} kg`:`${s.weightDelta.toFixed(1)} kg`);
  return `This week:
‚Ä¢ Protein goals hit: ${s.proteinHits}/7
‚Ä¢ Workouts completed: ${s.workouts}
‚Ä¢ Beers: ${s.beersTotal}
‚Ä¢ Days logged: ${s.daysLogged}/7
‚Ä¢ Weight change: ${dir}

Verdict: ${ (s.proteinHits>=5 && s.workouts>=3 && (s.beersTotal<=4)) ? "GREEN ‚Äî keep the chest priority and push +2.5 kg or +1 rep next week." : "YELLOW ‚Äî tighten protein hits to 6/7 and keep beers ‚â§4; schedule workouts on calendar." }`;
}
function showDigest(){
  const txt = digestText().replace(/\n/g,'<br>');
  modal(`<h3>Weekly Digest</h3><div class="small">${txt}</div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="copyDigest">Copy</button>
      <button class="btn ghost" onclick="document.getElementById('modal').style.display='none'">Close</button>
    </div>`);
  document.getElementById('copyDigest').onclick = async ()=>{
    try{ await navigator.clipboard.writeText(digestText()); alert("Copied"); }catch(e){ alert("Copy failed"); }
  };
}
document.getElementById('openDigest').onclick = showDigest;

// Auto popup Sundays at 20:00 (local time). To avoid repeated pop within the hour, store a flag per date.
(function weeklyAutoDigest(){
  const now = new Date();
  const dow = now.getDay(); // 0=Sun
  const hour = now.getHours();
  const flagKey = 'digest:'+todayKey();
  const triggered = G(flagKey,false);
  if(dow===0 && hour>=20 && !triggered){
    showDigest();
    S(flagKey,true);
  }
})();

/* ===== Steps checkbox (manual) ‚Äî keeps you honest on iPad-only days ===== */
if(!day.goals.steps && confirm("Mark steps goal as done for today? (7.5‚Äì10k)")){
  day.goals.steps = true; saveDay();
}
</script>
</body>
</html>
